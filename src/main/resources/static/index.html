<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  - í•´ìš” (ë¸Œì´ì›”ë“œ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .username {
            color: white;
            font-weight: 600;
        }
        
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .search-box button:hover {
            background: #5568d3;
        }
        
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive {
            background-color: #f44336;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-center {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-banner {
            background: #f44336;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .result-address {
            font-size: 13px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .location-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .button-group {
                width: 100%;
            }
            
            button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  (ë¸Œì´ì›”ë“œ)</h1>
            <div class="user-info">
                <span class="username" id="userInfo"></span>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
    
    <div id="error" class="error-banner"></div>
    
    <div id="map"></div>
    
    <div class="control-panel">
        <!-- ì¥ì†Œ ê²€ìƒ‰ -->
        <div class="search-container">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="ğŸ” ì¥ì†Œ, ê±´ë¬¼ëª…, ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') searchPlace()"
                />
                <button onclick="searchPlace()">ê²€ìƒ‰</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- ìœ„ì¹˜ ì •ë³´ -->
        <div class="location-info">
            <div class="info-card">
                <div class="info-label">ìœ„ë„</div>
                <div class="info-value" id="latitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ê²½ë„</div>
                <div class="info-value" id="longitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ì •í™•ë„</div>
                <div class="info-value" id="accuracy">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ì—…ë°ì´íŠ¸</div>
                <div class="info-value" id="lastUpdate">-</div>
            </div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
        <div class="controls">
            <div class="status">
                <div class="status-dot inactive" id="statusDot"></div>
                <span id="statusText">ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ë¨</span>
            </div>
            
            <div class="button-group">
                <button class="btn-start" id="startBtn" onclick="startTracking()">
                    ğŸ¯ ì¶”ì  ì‹œì‘
                </button>
                <button class="btn-stop" id="stopBtn" onclick="stopTracking()" style="display: none;">
                    â¸ï¸ ì¶”ì  ì¤‘ì§€
                </button>
                <button class="btn-center" id="centerBtn" onclick="centerMap()" disabled>
                    ğŸ“Œ ë‚´ ìœ„ì¹˜ë¡œ
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>
    <script>
        const API_KEY = 'C52BE737-A08C-392F-978D-57BF695EEC19';
        let map;
        let marker;
        let markerLayer;
        let pathLayer;
        let watchId = null;
        let isTracking = false;
        let currentPosition = null;
        let path = [];

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // ë§ˆì»¤ ë ˆì´ì–´
            markerLayer = new ol.layer.Vector({
                source: new ol.source.Vector()
            });

            // ê²½ë¡œ ë ˆì´ì–´
            pathLayer = new ol.layer.Vector({
                source: new ol.source.Vector()
            });

            // ë¸Œì´ì›”ë“œ íƒ€ì¼ ë ˆì´ì–´
            const baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: `http://api.vworld.kr/req/wmts/1.0.0/${API_KEY}/Base/{z}/{y}/{x}.png`
                })
            });

            // ì§€ë„ ìƒì„± (ë¶€ì‚° ì¤‘ì‹¬)
            map = new ol.Map({
                target: 'map',
                layers: [baseLayer, pathLayer, markerLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat([129.0756, 35.1796]),
                    zoom: 13
                })
            });

            // ì´ˆê¸° ë§ˆì»¤ ìƒì„±
            createMarker([129.0756, 35.1796]);
        }

        // ë§ˆì»¤ ìƒì„±
        function createMarker(coords) {
            const markerSource = markerLayer.getSource();
            markerSource.clear();

            marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(coords))
            });

            marker.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    scale: 0.8,
                    src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="%23667eea" stroke="white" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>'
                })
            }));

            markerSource.addFeature(marker);
        }

        // ì¥ì†Œ ê²€ìƒ‰
        async function searchPlace() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(
                    `http://api.vworld.kr/req/search?service=search&request=search&version=2.0&crs=EPSG:4326&size=10&page=1&query=${encodeURIComponent(query)}&type=place&key=${API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.response.status === 'OK' && data.response.result.items.length > 0) {
                    displaySearchResults(data.response.result.items);
                } else {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(items) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div class="result-title">${item.title}</div>
                    <div class="result-address">${item.address?.road || item.address?.parcel || ''}</div>
                `;
                div.onclick = () => {
                    const lon = parseFloat(item.point.x);
                    const lat = parseFloat(item.point.y);
                    moveToLocation([lon, lat]);
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
        }

        // íŠ¹ì • ìœ„ì¹˜ë¡œ ì´ë™
        function moveToLocation(coords) {
            createMarker(coords);
            map.getView().animate({
                center: ol.proj.fromLonLat(coords),
                zoom: 17,
                duration: 1000
            });
        }

        // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        function startTracking() {
            if (!navigator.geolocation) {
                showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handleError,
                options
            );

            isTracking = true;
            path = [];
            pathLayer.getSource().clear();
            updateUI();
        }

        // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            currentPosition = [lng, lat];
            path.push([lng, lat]);

            // ë§ˆì»¤ ì—…ë°ì´íŠ¸
            createMarker([lng, lat]);
            
            // ì²« ìœ„ì¹˜ ì‹œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            if (path.length === 1) {
                map.getView().animate({
                    center: ol.proj.fromLonLat([lng, lat]),
                    zoom: 16,
                    duration: 1000
                });
            }

            // ì´ë™ ê²½ë¡œ ê·¸ë¦¬ê¸°
            if (path.length > 1) {
                const pathSource = pathLayer.getSource();
                pathSource.clear();

                const lineString = new ol.geom.LineString(
                    path.map(coord => ol.proj.fromLonLat(coord))
                );

                const pathFeature = new ol.Feature({
                    geometry: lineString
                });

                pathFeature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#667eea',
                        width: 4
                    })
                }));

                pathSource.addFeature(pathFeature);
            }

            // ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + 'm';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
            document.getElementById('centerBtn').disabled = false;

            hideError();
        }

        // ì—ëŸ¬ ì²˜ë¦¬
        function handleError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    stopTracking();
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    break;
                case error.TIMEOUT:
                    message = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    break;
                default:
                    message = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
            
            showError(message);
        }

        // ì¶”ì  ì¤‘ì§€
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            updateUI();
        }

        // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
        function centerMap() {
            if (currentPosition) {
                map.getView().animate({
                    center: ol.proj.fromLonLat(currentPosition),
                    zoom: 16,
                    duration: 500
                });
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (isTracking) {
                statusDot.classList.remove('inactive');
                statusDot.classList.add('active');
                statusText.textContent = 'ìœ„ì¹˜ ì¶”ì  ì¤‘';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } else {
                statusDot.classList.remove('active');
                statusDot.classList.add('inactive');
                statusText.textContent = 'ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ë¨';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorBanner = document.getElementById('error');
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
        }

        // ì—ëŸ¬ ìˆ¨ê¸°ê¸°
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.onload = function() {
            // ë¡œê·¸ì¸ ì²´í¬
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            if (username) {
                document.getElementById('userInfo').textContent = `${username}ë‹˜`;
            }
            
            initMap();
        };
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>