<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  - í•´ìš”</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 24px; font-weight: 600; }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .username { color: white; font-weight: 600; }
        
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        
        #map { flex: 1; width: 100%; cursor: crosshair; }
        
        .control-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .search-container { margin-bottom: 15px; }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .search-box button:hover { background: #5568d3; }
        
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive { background-color: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-start:hover { transform: translateY(-2px); }
        
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-center {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-banner {
            background: #f44336;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover { background: #f8f9fa; }
        .search-result-item:last-child { border-bottom: none; }

        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .result-address {
            font-size: 13px;
            color: #666;
        }

        /* ê²Œì‹œë¬¼ ì‘ì„± ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .category-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .category-btn:hover { border-color: #667eea; }

        .category-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .category-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .image-upload input { display: none; }

        .image-preview {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ê²Œì‹œë¬¼ íŒì—… */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            bottom: 12px;
            left: -50px;
            min-width: 250px;
        }
        
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 20px;
            color: #999;
        }
        
        .ol-popup-closer:after {
            content: "âœ–";
        }

        .popup-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .popup-category.TRASH {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .popup-category.DAMAGE {
            background: #fff3e0;
            color: #f57c00;
        }

        .popup-category.WILDLIFE {
            background: #e8f5e9;
            color: #388e3c;
        }

        .popup-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .popup-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .popup-address {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .popup-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .location-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls { flex-direction: column; }
            .button-group { width: 100%; }
            button { flex: 1; }
            .category-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì </h1>
            <div class="user-info">
                <span class="username" id="userInfo"></span>
                
            </div>
        </div>
    </div>
    
    <div id="error" class="error-banner"></div>
    
    <div id="map"></div>
    
    <div class="control-panel">
        <div class="search-container">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="ğŸ” ì¥ì†Œ, ê±´ë¬¼ëª…, ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') searchPlace()"
                />
                <button onclick="searchPlace()">ê²€ìƒ‰</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="location-info">
            <div class="info-card">
                <div class="info-label">ìœ„ë„</div>
                <div class="info-value" id="latitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ê²½ë„</div>
                <div class="info-value" id="longitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ì •í™•ë„</div>
                <div class="info-value" id="accuracy">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ì—…ë°ì´íŠ¸</div>
                <div class="info-value" id="lastUpdate">-</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="status">
                <div class="status-dot inactive" id="statusDot"></div>
                <span id="statusText">ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ë¨</span>
            </div>
            
            <div class="button-group">
                <button class="btn-start" id="startBtn" onclick="startTracking()">
                    ğŸ¯ ì¶”ì  ì‹œì‘
                </button>
                <button class="btn-stop" id="stopBtn" onclick="stopTracking()" style="display: none;">
                    â¸ï¸ ì¶”ì  ì¤‘ì§€
                </button>
                <button class="btn-center" id="centerBtn" onclick="centerMap()" disabled>
                    ğŸ“Œ ë‚´ ìœ„ì¹˜ë¡œ
                </button>
            </div>
        </div>
    </div>

    <!-- ê²Œì‹œë¬¼ ì‘ì„± ëª¨ë‹¬ -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ ê²Œì‹œë¬¼ ì‘ì„±</h2>
                <button class="btn-close" onclick="closePostModal()">&times;</button>
            </div>
            
            <form id="postForm">
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                    <div class="category-grid">
                        <div class="category-btn" data-category="TRASH">
                            <div class="category-icon">ğŸ—‘ï¸</div>
                            <div class="category-name">ì“°ë ˆê¸°</div>
                        </div>
                        <div class="category-btn" data-category="DAMAGE">
                            <div class="category-icon">âš ï¸</div>
                            <div class="category-name">ê¸°ë¬¼íŒŒì†</div>
                        </div>
                        <div class="category-btn" data-category="WILDLIFE">
                            <div class="category-icon">ğŸ¦‹</div>
                            <div class="category-name">ìƒë¬¼</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="postDescription" placeholder="ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <div class="form-group">
                    <label>ì‚¬ì§„ ì²¨ë¶€</label>
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <div>ğŸ“· ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">ê²Œì‹œí•˜ê¸°</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>
    <script>
        const API_KEY = 'C52BE737-A08C-392F-978D-57BF695EEC19';
        let map, marker, markerLayer, pathLayer, postLayer;
        let watchId = null;
        let isTracking = false;
        let currentPosition = null;
        let path = [];
        let selectedCategory = null;
        let selectedCoords = null;
        let selectedImageBase64 = null;
        let overlay;

        function initMap() {
            markerLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
            pathLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
            postLayer = new ol.layer.Vector({ source: new ol.source.Vector() });

            const baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: `http://api.vworld.kr/req/wmts/1.0.0/${API_KEY}/Base/{z}/{y}/{x}.png`
                })
            });

            const container = document.createElement('div');
            container.className = 'ol-popup';
            container.innerHTML = '<a href="#" class="ol-popup-closer"></a><div id="popup-content"></div>';
            
            overlay = new ol.Overlay({
                element: container,
                autoPan: true,
                autoPanAnimation: { duration: 250 }
            });

            map = new ol.Map({
                target: 'map',
                layers: [baseLayer, pathLayer, postLayer, markerLayer],
                overlays: [overlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([129.0756, 35.1796]),
                    zoom: 13
                })
            });

            createMarker([129.0756, 35.1796]);
            map.on('click', handleMapClick);
            
            container.querySelector('.ol-popup-closer').onclick = function() {
                overlay.setPosition(undefined);
                this.blur();
                return false;
            };

            loadPosts();
        }

        function handleMapClick(event) {
            const feature = map.forEachFeatureAtPixel(event.pixel, f => f);
            
            if (feature && feature.get('post')) {
                const post = feature.get('post');
                showPostPopup(post, event.coordinate);
            } else {
                const coords = ol.proj.toLonLat(event.coordinate);
                selectedCoords = coords;
                openPostModal(coords);
            }
        }

        function showPostPopup(post, coordinate) {
            const categoryNames = {
                'TRASH': 'ì“°ë ˆê¸°',
                'DAMAGE': 'ê¸°ë¬¼íŒŒì†',
                'WILDLIFE': 'ìƒë¬¼'
            };
            
            let content = `
                <div class="popup-category ${post.category}">${categoryNames[post.category]}</div>
            `;
            
            if (post.imageUrl) {
                content += `<img src="${post.imageUrl}" class="popup-image" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">`;
            }
            
            if (post.description) {
                content += `<div class="popup-description">${post.description}</div>`;
            }
            
            if (post.address) {
                content += `<div class="popup-address">ğŸ“ ${post.address}</div>`;
            }
            
            content += `
                <div class="popup-meta">
                    <span>ğŸ‘¤ ${post.username}</span>
                    <span>ğŸ• ${post.createdAt}</span>
                </div>
            `;
            
            document.getElementById('popup-content').innerHTML = content;
            overlay.setPosition(coordinate);
        }

        function openPostModal(coords) {
            document.getElementById('postModal').classList.add('active');
            selectedCategory = null;
            selectedImageBase64 = null;
            document.getElementById('postForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function closePostModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCategory = this.dataset.category;
                });
            });
        });

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedCategory) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            const description = document.getElementById('postDescription').value;
            const username = localStorage.getItem('username');

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ê²Œì‹œ ì¤‘...';

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': username
                    },
                    body: JSON.stringify({
                        latitude: selectedCoords[1],
                        longitude: selectedCoords[0],
                        category: selectedCategory,
                        description: description,
                        imageBase64: selectedImageBase64
                    })
                });

                if (response.ok) {
                    alert('ê²Œì‹œë¬¼ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closePostModal();
                    loadPosts();
                } else {
                    const error = await response.json();
                    alert('ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨: ' + error.error);
                }
            } catch (error) {
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²Œì‹œí•˜ê¸°';
            }
        });

        async function loadPosts() {
            try {
                const response = await fetch('/api/posts');
                const posts = await response.json();

                const postSource = postLayer.getSource();
                postSource.clear();

                posts.forEach(post => {
                    createPostMarker(post);
                });
            } catch (error) {
                console.error('ê²Œì‹œë¬¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function createPostMarker(post) {
            const categoryIcons = {
                'TRASH': 'ğŸ—‘ï¸',
                'DAMAGE': 'âš ï¸',
                'WILDLIFE': 'ğŸ¦‹'
            };

            const categoryColors = {
                'TRASH': '#d32f2f',
                'DAMAGE': '#f57c00',
                'WILDLIFE': '#388e3c'
            };

            const icon = categoryIcons[post.category] || 'ğŸ“';
            const color = categoryColors[post.category] || '#667eea';

            const feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([post.longitude, post.latitude])),
                post: post
            });

            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                <path d="M20 0C11.163 0 4 7.163 4 16c0 12 16 34 16 34s16-22 16-34c0-8.837-7.163-16-16-16z" fill="${color}"/>
                <text x="20" y="20" text-anchor="middle" font-size="18" fill="white">${icon}</text>
            </svg>`;

            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    scale: 0.8,
                    src: 'data:image/svg+xml;utf8,' + encodeURIComponent(svgIcon)
                })
            }));

            postLayer.getSource().addFeature(feature);
        }

        function createMarker(coords) {
            const markerSource = markerLayer.getSource();
            markerSource.clear();

            marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(coords))
            });

            marker.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    scale: 0.8,
                    src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="%23667eea" stroke="white" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>'
                })
            }));

            markerSource.addFeature(marker);
        }

        async function searchPlace() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(
                    `http://api.vworld.kr/req/search?service=search&request=search&version=2.0&crs=EPSG:4326&size=10&page=1&query=${encodeURIComponent(query)}&type=place&key=${API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.response.status === 'OK' && data.response.result.items.length > 0) {
                    displaySearchResults(data.response.result.items);
                } else {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        function displaySearchResults(items) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div class="result-title">${item.title}</div>
                    <div class="result-address">${item.address?.road || item.address?.parcel || ''}</div>
                `;
                div.onclick = () => {
                    const lon = parseFloat(item.point.x);
                    const lat = parseFloat(item.point.y);
                    moveToLocation([lon, lat]);
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
        }

        function moveToLocation(coords) {
            createMarker(coords);
            map.getView().animate({
                center: ol.proj.fromLonLat(coords),
                zoom: 17,
                duration: 1000
            });
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handleError,
                options
            );

            isTracking = true;
            path = [];
            pathLayer.getSource().clear();
            updateUI();
        }

        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            currentPosition = [lng, lat];
            path.push([lng, lat]);

            createMarker([lng, lat]);
            
            if (path.length === 1) {
                map.getView().animate({
                    center: ol.proj.fromLonLat([lng, lat]),
                    zoom: 16,
                    duration: 1000
                });
            }

            if (path.length > 1) {
                const pathSource = pathLayer.getSource();
                pathSource.clear();

                const lineString = new ol.geom.LineString(
                    path.map(coord => ol.proj.fromLonLat(coord))
                );

                const pathFeature = new ol.Feature({
                    geometry: lineString
                });

                pathFeature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#667eea',
                        width: 4
                    })
                }));

                pathSource.addFeature(pathFeature);
            }

            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + 'm';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
            document.getElementById('centerBtn').disabled = false;

            hideError();
        }

        function handleError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    stopTracking();
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    break;
                case error.TIMEOUT:
                    message = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    break;
                default:
                    message = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
            
            showError(message);
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            updateUI();
        }

        function centerMap() {
            if (currentPosition) {
                map.getView().animate({
                    center: ol.proj.fromLonLat(currentPosition),
                    zoom: 16,
                    duration: 500
                });
            }
        }

        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (isTracking) {
                statusDot.classList.remove('inactive');
                statusDot.classList.add('active');
                statusText.textContent = 'ìœ„ì¹˜ ì¶”ì  ì¤‘';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } else {
                statusDot.classList.remove('active');
                statusDot.classList.add('inactive');
                statusText.textContent = 'ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ë¨';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        function showError(message) {
            const errorBanner = document.getElementById('error');
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
        }

        function getCurrentUser() {
            const userStr = localStorage.getItem('user');
            return userStr ? JSON.parse(userStr) : null;
        }

        // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
        function isLoggedIn() {
            return getCurrentUser() !== null;
        }

        // ë§ˆì»¤ ìƒì„± ì‹œë„
        async function createPost(postData) {
            const user = getCurrentUser();
            
            // ë¡œê·¸ì¸ í™•ì¸
            if (!user) {
                // ë¡œê·¸ì¸ ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ
                if (confirm('ë§ˆì»¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = '/login.html';
                }
                return null;
            }
            
            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': user.username
                    },
                    body: JSON.stringify(postData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.requireLogin) {
                        // ë¡œê·¸ì¸ í•„ìš” ì—ëŸ¬
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                        window.location.href = '/login.html';
                        return null;
                    }
                    throw new Error(data.error || 'ê²Œì‹œë¬¼ ìƒì„± ì‹¤íŒ¨');
                }
                
                return data;
            } catch (error) {
                console.error('Error creating post:', error);
                alert(error.message);
                return null;
            }
        }

        // ë§ˆì»¤ ì¡°íšŒ (ë¡œê·¸ì¸ ë¶ˆí•„ìš”)
        async function loadPosts() {
            try {
                const response = await fetch('/api/posts');
                const posts = await response.json();
                return posts;
            } catch (error) {
                console.error('Error loading posts:', error);
                return [];
            }
        }

        // ì˜ì—­ ë‚´ ë§ˆì»¤ ì¡°íšŒ (ë¡œê·¸ì¸ ë¶ˆí•„ìš”)
        async function loadPostsInBounds(bounds) {
            const params = new URLSearchParams({
                minLat: bounds.minLat,
                maxLat: bounds.maxLat,
                minLon: bounds.minLon,
                maxLon: bounds.maxLon
            });
            
            try {
                const response = await fetch(`/api/posts/bounds?${params}`);
                const posts = await response.json();
                return posts;
            } catch (error) {
                console.error('Error loading posts:', error);
                return [];
            }
        }

        // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì˜ˆì œ
        function handleMapClick(lat, lng) {
            if (!isLoggedIn()) {
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
                showLoginPrompt();
                return;
            }
            
            // ë¡œê·¸ì¸í•œ ê²½ìš° ë§ˆì»¤ ìƒì„± í¼ í‘œì‹œ
            showCreatePostForm(lat, lng);
        }

        // ë¡œê·¸ì¸ ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ
        function showLoginPrompt() {
            const modal = document.createElement('div');
            modal.className = 'login-prompt-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                    <p>ë§ˆì»¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                    <p>ë§ˆì»¤ ì¡°íšŒëŠ” ë¡œê·¸ì¸ ì—†ì´ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <div class="modal-buttons">
                        <button onclick="window.location.href='/login.html'">ë¡œê·¸ì¸</button>
                        <button onclick="this.closest('.login-prompt-modal').remove()">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ë§ˆì»¤ ìƒì„± í¼ í‘œì‹œ
        function showCreatePostForm(lat, lng) {
            const modal = document.createElement('div');
            modal.className = 'create-post-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ë§ˆì»¤ ìƒì„±</h3>
                    <form id="createPostForm">
                        <input type="hidden" name="latitude" value="${lat}">
                        <input type="hidden" name="longitude" value="${lng}">
                        
                        <label>ì¹´í…Œê³ ë¦¬:</label>
                        <select name="category" required>
                            <option value="TRASH">ì“°ë ˆê¸°</option>
                            <option value="DAMAGE">ì‹œì„¤ë¬¼ íŒŒì†</option>
                            <option value="WILDLIFE">ì•¼ìƒë™ë¬¼</option>
                        </select>
                        
                        <label>ì„¤ëª…:</label>
                        <textarea name="description" rows="4"></textarea>
                        
                        <label>ì‚¬ì§„:</label>
                        <input type="file" accept="image/*" id="imageInput">
                        
                        <div class="modal-buttons">
                            <button type="submit">ìƒì„±</button>
                            <button type="button" onclick="this.closest('.create-post-modal').remove()">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('createPostForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                const postData = {
                    latitude: parseFloat(formData.get('latitude')),
                    longitude: parseFloat(formData.get('longitude')),
                    category: formData.get('category'),
                    description: formData.get('description')
                };
                
                // ì´ë¯¸ì§€ ì²˜ë¦¬
                const imageFile = document.getElementById('imageInput').files[0];
                if (imageFile) {
                    postData.imageBase64 = await fileToBase64(imageFile);
                }
                
                const result = await createPost(postData);
                if (result) {
                    alert('ë§ˆì»¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    modal.remove();
                    // ì§€ë„ ìƒˆë¡œê³ ì¹¨ ë“±
                    loadPosts();
                }
            });
        }

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
        function updateLoginStatus() {
            const user = getCurrentUser();
            const loginStatusElement = document.getElementById('loginStatus');
            
            if (user) {
                loginStatusElement.innerHTML = `
                    <span>í™˜ì˜í•©ë‹ˆë‹¤, ${user.username}ë‹˜</span>
                    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
            } else {
                loginStatusElement.innerHTML = `
                    <span>ë§ˆì»¤ ìƒì„±ì€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                    <button onclick="window.location.href='/login.html'">ë¡œê·¸ì¸</button>
                `;
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('user');
            alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.reload();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            updateLoginStatus();
            loadPosts(); // ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë§ˆì»¤ ì¡°íšŒ
        });

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        window.onload = function() {
            updateLoginStatus();  // ë¡œê·¸ì¸ ìƒíƒœë§Œ UIì— í‘œì‹œ
            initMap();            // ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì§€ë„ ì´ˆê¸°í™”
        };
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('user');
            alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/index.html';  // âœ… index.htmlì— ìœ ì§€
        }

    function updateLoginStatus() {
        const username = localStorage.getItem('username');
        const userInfoDiv = document.getElementById('userInfo');
        
        if (username) {
            userInfoDiv.innerHTML = `
                <span class="username">${username}ë‹˜</span>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            `;
        } else {
            userInfoDiv.innerHTML = `
                <span class="username">ë§ˆì»¤ ìƒì„±ì€ ë¡œê·¸ì¸ í•„ìš”</span>
                <button class="btn-login" onclick="window.location.href='/login.html'">ë¡œê·¸ì¸</button>
            `;
        }
    }
    </script>
</body>
</html>