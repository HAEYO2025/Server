<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïã§ÏãúÍ∞Ñ ÏúÑÏπò Ï∂îÏ†Å - Ìï¥Ïöî</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 24px; font-weight: 600; }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .username { color: white; font-weight: 600; }
        
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        
        #map { flex: 1; width: 100%; cursor: crosshair; }
        
        .control-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .search-container { margin-bottom: 15px; }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .search-box button:hover { background: #5568d3; }
        
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive { background-color: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-start:hover { transform: translateY(-2px); }
        
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-center {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-banner {
            background: #f44336;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover { background: #f8f9fa; }
        .search-result-item:last-child { border-bottom: none; }

        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .result-address {
            font-size: 13px;
            color: #666;
        }

        /* Í≤åÏãúÎ¨º ÏûëÏÑ± Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .category-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .category-btn:hover { border-color: #667eea; }

        .category-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .category-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .image-upload input { display: none; }

        .image-preview {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Í≤åÏãúÎ¨º ÌåùÏóÖ */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            bottom: 12px;
            left: -50px;
            min-width: 250px;
        }
        
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 20px;
            color: #999;
        }
        
        .ol-popup-closer:after {
            content: "‚úñ";
        }

        .popup-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .popup-category.TRASH {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .popup-category.DAMAGE {
            background: #fff3e0;
            color: #f57c00;
        }

        .popup-category.WILDLIFE {
            background: #e8f5e9;
            color: #388e3c;
        }

        .popup-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .popup-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .popup-address {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .popup-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .location-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls { flex-direction: column; }
            .button-group { width: 100%; }
            button { flex: 1; }
            .category-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üìç Ïã§ÏãúÍ∞Ñ ÏúÑÏπò Ï∂îÏ†Å</h1>
            <div class="user-info">
                <span class="username" id="userInfo"></span>
                <button class="btn-logout" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
        </div>
    </div>
    
    <div id="error" class="error-banner"></div>
    
    <div id="map"></div>
    
    <div class="control-panel">
        <div class="search-container">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="üîç Ïû•ÏÜå, Í±¥Î¨ºÎ™Ö, Ï£ºÏÜåÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî"
                    onkeypress="if(event.key==='Enter') searchPlace()"
                />
                <button onclick="searchPlace()">Í≤ÄÏÉâ</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="location-info">
            <div class="info-card">
                <div class="info-label">ÏúÑÎèÑ</div>
                <div class="info-value" id="latitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Í≤ΩÎèÑ</div>
                <div class="info-value" id="longitude">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Ï†ïÌôïÎèÑ</div>
                <div class="info-value" id="accuracy">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ÏóÖÎç∞Ïù¥Ìä∏</div>
                <div class="info-value" id="lastUpdate">-</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="status">
                <div class="status-dot inactive" id="statusDot"></div>
                <span id="statusText">ÏúÑÏπò Ï∂îÏ†Å Ï§ëÏßÄÎê®</span>
            </div>
            
            <div class="button-group">
                <button class="btn-start" id="startBtn" onclick="startTracking()">
                    üéØ Ï∂îÏ†Å ÏãúÏûë
                </button>
                <button class="btn-stop" id="stopBtn" onclick="stopTracking()" style="display: none;">
                    ‚è∏Ô∏è Ï∂îÏ†Å Ï§ëÏßÄ
                </button>
                <button class="btn-center" id="centerBtn" onclick="centerMap()" disabled>
                    üìå ÎÇ¥ ÏúÑÏπòÎ°ú
                </button>
            </div>
        </div>
    </div>

    <!-- Í≤åÏãúÎ¨º ÏûëÏÑ± Î™®Îã¨ -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Í≤åÏãúÎ¨º ÏûëÏÑ±</h2>
                <button class="btn-close" onclick="closePostModal()">&times;</button>
            </div>
            
            <form id="postForm">
                <div class="form-group">
                    <label>Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</label>
                    <div class="category-grid">
                        <div class="category-btn" data-category="TRASH">
                            <div class="category-icon">üóëÔ∏è</div>
                            <div class="category-name">Ïì∞Î†àÍ∏∞</div>
                        </div>
                        <div class="category-btn" data-category="DAMAGE">
                            <div class="category-icon">‚ö†Ô∏è</div>
                            <div class="category-name">Í∏∞Î¨ºÌååÏÜê</div>
                        </div>
                        <div class="category-btn" data-category="WILDLIFE">
                            <div class="category-icon">ü¶ã</div>
                            <div class="category-name">ÏÉùÎ¨º</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ÏÑ§Î™Ö</label>
                    <textarea id="postDescription" placeholder="ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                </div>

                <div class="form-group">
                    <label>ÏÇ¨ÏßÑ Ï≤®Î∂Ä</label>
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <div>üì∑ ÏÇ¨ÏßÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
                        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">Í≤åÏãúÌïòÍ∏∞</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>
    <script>
        const API_KEY = 'C52BE737-A08C-392F-978D-57BF695EEC19';
        let map, marker, markerLayer, pathLayer, postLayer;
        let watchId = null;
        let isTracking = false;
        let currentPosition = null;
        let path = [];
        let selectedCategory = null;
        let selectedCoords = null;
        let selectedImageBase64 = null;
        let overlay;

        function initMap() {
            markerLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
            pathLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
            postLayer = new ol.layer.Vector({ source: new ol.source.Vector() });

            const baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: `http://api.vworld.kr/req/wmts/1.0.0/${API_KEY}/Base/{z}/{y}/{x}.png`
                })
            });

            const container = document.createElement('div');
            container.className = 'ol-popup';
            container.innerHTML = '<a href="#" class="ol-popup-closer"></a><div id="popup-content"></div>';
            
            overlay = new ol.Overlay({
                element: container,
                autoPan: true,
                autoPanAnimation: { duration: 250 }
            });

            map = new ol.Map({
                target: 'map',
                layers: [baseLayer, pathLayer, postLayer, markerLayer],
                overlays: [overlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([129.0756, 35.1796]),
                    zoom: 13
                })
            });

            createMarker([129.0756, 35.1796]);
            map.on('click', handleMapClick);
            
            container.querySelector('.ol-popup-closer').onclick = function() {
                overlay.setPosition(undefined);
                this.blur();
                return false;
            };

            loadPosts();
        }

        function handleMapClick(event) {
            const feature = map.forEachFeatureAtPixel(event.pixel, f => f);
            
            if (feature && feature.get('post')) {
                const post = feature.get('post');
                showPostPopup(post, event.coordinate);
            } else {
                const coords = ol.proj.toLonLat(event.coordinate);
                selectedCoords = coords;
                openPostModal(coords);
            }
        }

        function showPostPopup(post, coordinate) {
            const categoryNames = {
                'TRASH': 'Ïì∞Î†àÍ∏∞',
                'DAMAGE': 'Í∏∞Î¨ºÌååÏÜê',
                'WILDLIFE': 'ÏÉùÎ¨º'
            };
            
            let content = `
                <div class="popup-category ${post.category}">${categoryNames[post.category]}</div>
            `;
            
            if (post.imageUrl) {
                content += `<img src="${post.imageUrl}" class="popup-image" alt="Í≤åÏãúÎ¨º Ïù¥ÎØ∏ÏßÄ">`;
            }
            
            if (post.description) {
                content += `<div class="popup-description">${post.description}</div>`;
            }
            
            if (post.address) {
                content += `<div class="popup-address">üìç ${post.address}</div>`;
            }
            
            content += `
                <div class="popup-meta">
                    <span>üë§ ${post.username}</span>
                    <span>üïê ${post.createdAt}</span>
                </div>
            `;
            
            document.getElementById('popup-content').innerHTML = content;
            overlay.setPosition(coordinate);
        }

        function openPostModal(coords) {
            document.getElementById('postModal').classList.add('active');
            selectedCategory = null;
            selectedImageBase64 = null;
            document.getElementById('postForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function closePostModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCategory = this.dataset.category;
                });
            });
        });

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedCategory) {
                alert('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            const description = document.getElementById('postDescription').value;
            const username = localStorage.getItem('username');

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Í≤åÏãú Ï§ë...';

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': username
                    },
                    body: JSON.stringify({
                        latitude: selectedCoords[1],
                        longitude: selectedCoords[0],
                        category: selectedCategory,
                        description: description,
                        imageBase64: selectedImageBase64
                    })
                });

                if (response.ok) {
                    alert('Í≤åÏãúÎ¨ºÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                    closePostModal();
                    loadPosts();
                } else {
                    const error = await response.json();
                    alert('Í≤åÏãúÎ¨º ÏûëÏÑ± Ïã§Ìå®: ' + error.error);
                }
            } catch (error) {
                alert('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Í≤åÏãúÌïòÍ∏∞';
            }
        });

        async function loadPosts() {
            try {
                const response = await fetch('/api/posts');
                const posts = await response.json();

                const postSource = postLayer.getSource();
                postSource.clear();

                posts.forEach(post => {
                    createPostMarker(post);
                });
            } catch (error) {
                console.error('Í≤åÏãúÎ¨º Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        function createPostMarker(post) {
            const categoryIcons = {
                'TRASH': 'üóëÔ∏è',
                'DAMAGE': '‚ö†Ô∏è',
                'WILDLIFE': 'ü¶ã'
            };

            const categoryColors = {
                'TRASH': '#d32f2f',
                'DAMAGE': '#f57c00',
                'WILDLIFE': '#388e3c'
            };

            const icon = categoryIcons[post.category] || 'üìç';
            const color = categoryColors[post.category] || '#667eea';

            const feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([post.longitude, post.latitude])),
                post: post
            });

            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                <path d="M20 0C11.163 0 4 7.163 4 16c0 12 16 34 16 34s16-22 16-34c0-8.837-7.163-16-16-16z" fill="${color}"/>
                <text x="20" y="20" text-anchor="middle" font-size="18" fill="white">${icon}</text>
            </svg>`;

            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    scale: 0.8,
                    src: 'data:image/svg+xml;utf8,' + encodeURIComponent(svgIcon)
                })
            }));

            postLayer.getSource().addFeature(feature);
        }

        function createMarker(coords) {
            const markerSource = markerLayer.getSource();
            markerSource.clear();

            marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(coords))
            });

            marker.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    scale: 0.8,
                    src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="%23667eea" stroke="white" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>'
                })
            }));

            markerSource.addFeature(marker);
        }

        async function searchPlace() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            try {
                const response = await fetch(
                    `http://api.vworld.kr/req/search?service=search&request=search&version=2.0&crs=EPSG:4326&size=10&page=1&query=${encodeURIComponent(query)}&type=place&key=${API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.response.status === 'OK' && data.response.result.items.length > 0) {
                    displaySearchResults(data.response.result.items);
                } else {
                    alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§');
                }
            } catch (error) {
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
                alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
            }
        }

        function displaySearchResults(items) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div class="result-title">${item.title}</div>
                    <div class="result-address">${item.address?.road || item.address?.parcel || ''}</div>
                `;
                div.onclick = () => {
                    const lon = parseFloat(item.point.x);
                    const lat = parseFloat(item.point.y);
                    moveToLocation([lon, lat]);
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
        }

        function moveToLocation(coords) {
            createMarker(coords);
            map.getView().animate({
                center: ol.proj.fromLonLat(coords),
                zoom: 17,
                duration: 1000
            });
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showError('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handleError,
                options
            );

            isTracking = true;
            path = [];
            pathLayer.getSource().clear();
            updateUI();
        }

        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            currentPosition = [lng, lat];
            path.push([lng, lat]);

            createMarker([lng, lat]);
            
            if (path.length === 1) {
                map.getView().animate({
                    center: ol.proj.fromLonLat([lng, lat]),
                    zoom: 16,
                    duration: 1000
                });
            }

            if (path.length > 1) {
                const pathSource = pathLayer.getSource();
                pathSource.clear();

                const lineString = new ol.geom.LineString(
                    path.map(coord => ol.proj.fromLonLat(coord))
                );

                const pathFeature = new ol.Feature({
                    geometry: lineString
                });

                pathFeature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#667eea',
                        width: 4
                    })
                }));

                pathSource.addFeature(pathFeature);
            }

            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + 'm';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
            document.getElementById('centerBtn').disabled = false;

            hideError();
        }

        function handleError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.';
                    stopTracking();
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
                    break;
                case error.TIMEOUT:
                    message = 'ÏúÑÏπò ÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.';
                    break;
                default:
                    message = 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
            }
            
            showError(message);
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            updateUI();
        }

        function centerMap() {
            if (currentPosition) {
                map.getView().animate({
                    center: ol.proj.fromLonLat(currentPosition),
                    zoom: 16,
                    duration: 500
                });
            }
        }

        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (isTracking) {
                statusDot.classList.remove('inactive');
                statusDot.classList.add('active');
                statusText.textContent = 'ÏúÑÏπò Ï∂îÏ†Å Ï§ë';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } else {
                statusDot.classList.remove('active');
                statusDot.classList.add('inactive');
                statusText.textContent = 'ÏúÑÏπò Ï∂îÏ†Å Ï§ëÏßÄÎê®';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        function showError(message) {
            const errorBanner = document.getElementById('error');
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        window.onload = function() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            if (username) {
                document.getElementById('userInfo').textContent = `${username}Îãò`;
            }
            
            initMap();
        };
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>